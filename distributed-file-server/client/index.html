<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed File Server</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1, h2 { color: #222; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .upload-form { margin-bottom: 2rem; }
        input[type="file"] { border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 0.6rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background-color: #0056b3; }
        .file-list, .status-list { list-style-type: none; padding: 0; }
        .file-list li, .status-list li { background-color: #fdfdfd; border: 1px solid #eee; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .status-list .online { color: #28a745; }
        .status-list .offline { color: #dc3545; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online .status-dot { background-color: #28a745; }
        .offline .status-dot { background-color: #dc3545; }
        .feedback { margin-top: 1rem; padding: 0.75rem; border-radius: 4px; background-color: #e9ecef; color: #495057; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Distributed File Server</h1>
        
        <div class="upload-form">
            <h2>Upload a File</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" id="fileInput" required>
                <button type="submit">Upload</button>
            </form>
        </div>

        <div id="feedback" class="feedback" style="display: none;"></div>

        <div>
            <h2>Available Files</h2>
            <ul id="fileList" class="file-list">
                <!-- File items will be injected here by JavaScript -->
            </ul>
        </div>

        <div>
            <h2>Chunk Server Status</h2>
            <ul id="statusList" class="status-list">
                <!-- Server statuses will be injected here by JavaScript -->
            </ul>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;

        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const feedbackDiv = document.getElementById('feedback');
        const fileListUl = document.getElementById('fileList');
        const statusListUl = document.getElementById('statusList');

        function showFeedback(message, isError = false) {
            feedbackDiv.textContent = message;
            feedbackDiv.style.display = 'block';
            feedbackDiv.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            feedbackDiv.style.color = isError ? '#721c24' : '#155724';
        }

        async function fetchFiles() {
            try {
                const response = await fetch(`${API_BASE_URL}/files`);
                if (!response.ok) throw new Error('Failed to fetch file list.');
                
                const files = await response.json();
                fileListUl.innerHTML = ''; // Clear existing list

                if (Object.keys(files).length === 0) {
                    fileListUl.innerHTML = '<li>No files have been uploaded yet.</li>';
                    return;
                }

                for (const filename in files) {
                    const file = files[filename];
                    const li = document.createElement('li');
                    
                    const sizeInKB = (file.size / 1024).toFixed(2);
                    
                    li.innerHTML = `
                        <span>${filename} (${sizeInKB} KB)</span>
                        <a href="/files/${filename}" download>Download</a>
                    `;
                    fileListUl.appendChild(li);
                }
            } catch (error) {
                showFeedback(error.message, true);
            }
        }

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/status`);
                if (!response.ok) throw new Error('Failed to fetch server status.');

                const statuses = await response.json();
                statusListUl.innerHTML = ''; // Clear existing list

                for (const chunkId in statuses) {
                    const server = statuses[chunkId];
                    const li = document.createElement('li');
                    const statusClass = server.online ? 'online' : 'offline';
                    
                    li.className = statusClass;
                    li.innerHTML = `
                        <span><span class="status-dot"></span>Chunk Server ${chunkId.toUpperCase()}</span>
                        <span>${server.online ? 'Online' : 'Offline'}</span>
                    `;
                    statusListUl.appendChild(li);
                }
            } catch (error) {
                console.error("Status fetch error:", error);
            }
        }
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInput.files.length) {
                showFeedback('Please select a file to upload.', true);
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            showFeedback('Uploading...', false);

            try {
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'An unknown error occurred.');
                }
                
                showFeedback(result.message || 'Upload successful!', false);
                fileInput.value = ''; // Reset file input
                fetchFiles(); // Refresh file list

            } catch (error) {
                showFeedback(error.message, true);
            }
        });

        // Initial data load and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchFiles();
            fetchStatus();
            setInterval(fetchStatus, 10000); // Refresh status every 10 seconds
        });
    </script>
</body>
</html>
